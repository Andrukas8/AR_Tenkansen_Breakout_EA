//+------------------------------------------------------------------+
//|                                        AR_Tenkansen_Breakout.mq5 |
//|                                                               AR |
//|                                                                  |
//+------------------------------------------------------------------+
#property copyright "AR Ichimoku"
#property link      ""
#property version   "1.00"

#include <Trade/Trade.mqh>

input group "Ichimoku inputs";
input int IchimokuMultiplier = 1;

input group "Trade settings";
input double PercentRisk = 2;
input double MinSLPoints = 10;
input double RiskToReward = 1;

input group "Position Management";
input bool Close_Pos_Kijunsen = false;
input bool Close_Pos_Tenkansen = false;
input bool Close_Pos_TK_Cross = false;

bool BuySignal_1 = false;
bool BuySignal_2 = false;
bool BuySignal_3 = false;
bool BuySignal_4 = false;
bool BuySignal_GO = false;

bool SellSignal_1 = false;
bool SellSignal_2 = false;
bool SellSignal_3 = false;
bool SellSignal_4 = false;
bool SellSignal_GO = false;

double ClosePrice_1;
double ClosePrice_2;
double ClosePrice_3;

int Tenkansen;
int Kijunsen;
int SenkouspanB;

int handleIchimoku;

string text;

CTrade trade;


//+------------------------------------------------------------------+
//| Expert initialization function                                   |
//+------------------------------------------------------------------+
int OnInit()
  {
//---
   Tenkansen = 9 * IchimokuMultiplier;
   Kijunsen = 26 * IchimokuMultiplier;
   SenkouspanB = 52 * IchimokuMultiplier;

   handleIchimoku = iIchimoku(_Symbol,PERIOD_CURRENT,Tenkansen,Kijunsen,SenkouspanB);
//---
   return(INIT_SUCCEEDED);
  }
//+------------------------------------------------------------------+
//| Expert deinitialization function                                 |
//+------------------------------------------------------------------+
void OnDeinit(const int reason)
  {
//---


  }

//+------------------------------------------------------------------+
//| Closing All Positions which are now open                         |
//+------------------------------------------------------------------+

//+------------------------------------------------------------------+
//|                                                                  |
//+------------------------------------------------------------------+
void closeAllPositions()
  {
   for(int i=PositionsTotal()-1; i>=0; i--)
     {
      ulong positionticket = PositionGetTicket(i);
      trade.PositionClose(positionticket,-1);
      Print("eliminando posiciÃ³n ",positionticket);
     }
  }

//+------------------------------------------------------------------+
//| Expert tick function                                             |
//+------------------------------------------------------------------+


//+------------------------------------------------------------------+
//|                                                                  |
//+------------------------------------------------------------------+
void OnTick()
  {
//---
   text = "";

   static datetime timeStamp;

   ClosePrice_1 = iClose(_Symbol,PERIOD_CURRENT,1);
   ClosePrice_2 = iClose(_Symbol,PERIOD_CURRENT,2);
   ClosePrice_3 = iClose(_Symbol,PERIOD_CURRENT,3);

   datetime time = iTime(_Symbol,PERIOD_CURRENT,0);

   text += "\n" + time + "\n" + "Close Price 1 = " + ClosePrice_1 + "\n" + "Close Price 2 = " + ClosePrice_2 + "\n" + "Close Price 3 = " + ClosePrice_3 + "\n";

   if(timeStamp != time)
     {
      timeStamp = time;

      double TenkansenArr[];
      double KijunsenArr[];
      double SenkouspanAArr[];
      double SenkouspanBArr[];

      double ShiftedSenkouspanAArr[];
      double ShiftedSenkouspanBArr[];

      double ChikouspanArr[];

      double spreadPos = (double)SymbolInfoInteger(Symbol(),SYMBOL_SPREAD);

      CopyBuffer(handleIchimoku,0,0,3,TenkansenArr);
      CopyBuffer(handleIchimoku,1,0,3,KijunsenArr);
      CopyBuffer(handleIchimoku,2,0,3,SenkouspanAArr);
      CopyBuffer(handleIchimoku,3,0,3,SenkouspanBArr);

      CopyBuffer(handleIchimoku,2,-Kijunsen,3,ShiftedSenkouspanAArr);
      CopyBuffer(handleIchimoku,3,-Kijunsen,3,ShiftedSenkouspanBArr);

      CopyBuffer(handleIchimoku,4,Kijunsen,1,ChikouspanArr);

      SellSignal_1 = SellSignal_2 = SellSignal_3 = SellSignal_4 = SellSignal_GO = false;
      BuySignal_1 = BuySignal_2 = BuySignal_3 = BuySignal_4 = BuySignal_GO = false;

      double ask = SymbolInfoDouble(_Symbol,SYMBOL_ASK);
      double bid = SymbolInfoDouble(_Symbol,SYMBOL_BID);
      double last = SymbolInfoDouble(_Symbol,SYMBOL_LAST);

      double slBuy = iLow(_Symbol,PERIOD_CURRENT,2);
      double slSell = iHigh(_Symbol,PERIOD_CURRENT,2);

      double ask_tp = ask + RiskToReward * (ask - slBuy);
      double bid_tp = bid - RiskToReward * (slSell - bid);

      int SlPointsBuy = (int)MathCeil((MathAbs(last - slBuy)) / _Point);
      int SlPointsSell = (int)MathCeil((MathAbs(last - slSell)) / _Point);

      Print(TenkansenArr[0] + "\n" + TenkansenArr[1] + "\n" + TenkansenArr[2]);

      Print("Low = ", slBuy," High = ",slSell);

      // % Risk Position Size
      double AccountBalance = NormalizeDouble(AccountInfoDouble(ACCOUNT_BALANCE),2);
      double AmountToRisk = NormalizeDouble(AccountBalance*PercentRisk/100,2);
      double ValuePp  = SymbolInfoDouble(_Symbol,SYMBOL_TRADE_TICK_VALUE);
      double LotsBuy  = NormalizeDouble(AmountToRisk/(SlPointsBuy)/ValuePp,2);
      double LotsSell = NormalizeDouble(AmountToRisk/(SlPointsSell)/ValuePp,2);

      text += "\nAccountBalance = " + AccountBalance + "\nAmountToRisk = " + AmountToRisk + "\nValuePp = " + ValuePp + "\nLotsBuy = " + LotsBuy + "\nLotsSell" + LotsSell + "\n";

      // Indicator Signals
      double Bar26High = iHigh(_Symbol,PERIOD_CURRENT,Kijunsen);
      double Bar26Low = iLow(_Symbol,PERIOD_CURRENT,Kijunsen);
      double CurrentHigh = iHigh(_Symbol,PERIOD_CURRENT,0);
      double CurrentLow = iLow(_Symbol,PERIOD_CURRENT,0);

      text += "\nBar26High = " + Bar26High + "\nBar26Low = " + Bar26Low + "\nCurrentHigh = " + CurrentHigh + "\nCurrentLow = " + CurrentLow + "\n";

      int Number_of_Positions =  PositionsTotal();

      // Close Position on Kijunsen Cross
      if(
         (
            (Close_Pos_Kijunsen) &&
            (last > KijunsenArr[0]) &&
            (SellSignal_1 == true)
         ) ||
         (
            (Close_Pos_Kijunsen) &&
            (last < KijunsenArr[0]) &&
            (BuySignal_1 == true))
      )

        {
         Print("Closing Position on Kijunsen = ",Close_Pos_Kijunsen);
         closeAllPositions();
        }


      // Close Position on Tenkansen Cross
      if(
         (
            (Close_Pos_Tenkansen) &&
            (last > TenkansenArr[0]) &&
            (SellSignal_1 == true)
         ) ||
         (
            (Close_Pos_Tenkansen) &&
            (last < TenkansenArr[0]) &&
            (BuySignal_1 == true))
      )

        {
         Print("Closing Position on Kijunsen = ",Close_Pos_Kijunsen);
         closeAllPositions();
        }

      text += "\nTenkansenArr[2] = " + TenkansenArr[2] + "\nKijunsenArr[2]" + KijunsenArr[2] + "\n";
      text += "\nTenkansenArr[1] = " + TenkansenArr[1] + "\nKijunsenArr[2]" + KijunsenArr[1] + "\n";
      text += "\nTenkansenArr[0] = " + TenkansenArr[0] + "\nKijunsenArr[0]" + KijunsenArr[0] + "\n";

      // BUY Trades

      // Buy Signal

      if(TenkansenArr[2] > KijunsenArr[2])
        {
         Print("Buy Cross");
         BuySignal_1 = true; // TK Cross
         SellSignal_1 = false; // cancelling sell signal
         if(Close_Pos_TK_Cross && (Number_of_Positions > 0 && SellSignal_1 == true))
           {
            Print("Closing Position on TK/KT Cross = ",Close_Pos_TK_Cross);
            closeAllPositions();
           }
        }


      if(ChikouspanArr[0] > Bar26High) // Chikou span above prices
        {
         BuySignal_2 = true;
         SellSignal_2 = false;
        }
      else
         BuySignal_2 = false;

      if((ShiftedSenkouspanAArr[0] > ShiftedSenkouspanBArr[0])) // Kumo green
        {
         BuySignal_3 = true;
         SellSignal_3 = false;
        }


      if(ClosePrice_2 < TenkansenArr[0] && ClosePrice_1 > TenkansenArr[1] && ClosePrice_2 > KijunsenArr[0]) // <<<<<<<<<<<<<<<<<<<<<<<< Buy Signal
        {
         BuySignal_4 = true;
         SellSignal_4 = false;
        }


      if(BuySignal_1 && BuySignal_2 && BuySignal_3 && BuySignal_4 && Number_of_Positions == 0 && CurrentHigh > SenkouspanBArr[0])
        {
         BuySignal_GO = true;
         SellSignal_GO = false;
        }

      if(BuySignal_GO && SlPointsBuy > MinSLPoints)
        {
         Print(__FUNCTION__," > Buy signal ",BuySignal_GO);
         trade.Buy(LotsBuy,_Symbol,ask,slBuy,ask_tp,"This is a BUY trade");
        }

      // SELL trades

      if(TenkansenArr[2] < KijunsenArr[2])
        {
         Print("Sell Cross");
         SellSignal_1 = true; // KT Cross

         if(Close_Pos_TK_Cross && (Number_of_Positions > 0 && BuySignal_1 == true))
           {
            Print("Closing Position on TK/KT Cross = ",Close_Pos_TK_Cross);
            closeAllPositions();
           }

         BuySignal_1 = false; // cancelling buy signal
        }

      if(ChikouspanArr[0] < Bar26Low)
        {
         SellSignal_2 = true;
         BuySignal_2 = false;
        }
      else
        {
         SellSignal_2 = false;
        }

      if((ShiftedSenkouspanAArr[0] < ShiftedSenkouspanBArr[0]))
        {
         SellSignal_3 = true;
         BuySignal_3 = false;
        }


      if(ClosePrice_2 > TenkansenArr[0] && ClosePrice_1 < TenkansenArr[1] && ClosePrice_2 < KijunsenArr[0]) // <<<<<<<<<<<<<<<<<<<<<<<< Sell Signal
        {
         BuySignal_4 = false;
         SellSignal_4 = true;
        }

      if(SellSignal_1 && SellSignal_2 && SellSignal_3 && BuySignal_4 && Number_of_Positions == 0 && CurrentLow < SenkouspanBArr[0])
        {
         SellSignal_GO = true;
         BuySignal_GO = false;
        }

      if(SellSignal_GO && SlPointsSell > MinSLPoints)
        {

         Print(__FUNCTION__," > Sell signal ",SellSignal_GO);
         trade.Sell(LotsSell,_Symbol,bid,slSell,bid_tp,"This is a SELL trade");
        }

      Print(BuySignal_1," ",BuySignal_2," ",BuySignal_3," ",BuySignal_4," ",BuySignal_GO,"\n",SellSignal_1," ",SellSignal_2," ",SellSignal_3," ",SellSignal_3," ",SellSignal_GO);

      text += "\nShiftedSenkouspanAArr[0] = " + ShiftedSenkouspanAArr[0] + "\nShiftedSenkouspanBArr[0] = " + ShiftedSenkouspanBArr[0] + "\n";
      text += "\n Buy Signels  = " + BuySignal_1 + " " + BuySignal_2 + " " + BuySignal_3 + " " + BuySignal_4 + " " + BuySignal_GO + "\n";
      text += "\n Sell Signals = " + SellSignal_1 + " " + SellSignal_2 + " " + SellSignal_3 + " " + SellSignal_3 + " " + SellSignal_GO + "\n";

      Comment(text);

      text = "";

     } // timestamp

  } // OnTick
//+------------------------------------------------------------------+
